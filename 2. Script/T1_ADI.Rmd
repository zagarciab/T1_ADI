---
title: "Taller 1 - Regresión e Interpretación Causal"
author: "Nicolas Jacome Velasco, Zaira Alejandra Garcia Bernal"
date: "2025-08-16"
output: pdf_document
---

# Evaluación de Impacto

## Taller 1: Regresión e Interpretación Causal

### 0. Carga de datos y paquetes

```{r}
# Liberias y paquetes
install.packages("haven") # Archivos .dta
install.packages("plm")
install.packages("skimr")
install.packages("dplyr")
install.packages("ggplot2")

library(haven)
library(plm)
library(skimr)
library(dplyr)
library(haven)
library(ggplot2)
```


```{r}
# Carga de datos .dta
url_data <- "https://github.com/zagarciab/T1_ADI/raw/main/3.%20Data/corruption_SV.dta"

base <- read_dta(url_data)
```

### 0.1 Exploración de los datos

```{r}
# Estructura de datos y estadísticas
str(base)
skim(base)

# Imputación de missing values

## Histogramas
ggplot(base, aes(prop)) +
  geom_histogram(color = "#000000", fill = "#0099F8") +
  geom_vline(xintercept = median(base$prop, na.rm = TRUE), linetype = "dashed", color = "red") +
  geom_vline(xintercept = mean(base$prop, na.rm = TRUE), linetype = "dashed", color = "blue") + 
  ggtitle("GRÁFICA 1 - Histograma de Prop ") +
  theme_bw() +
  theme(plot.title = element_text(size = 18))

ggplot(base, aes(unauthorized)) +
  geom_histogram(color = "#000000", fill = "#0099F8") +
  geom_vline(xintercept = median(base$unauthorized, na.rm = TRUE), linetype = "dashed", color = "red") +
  geom_vline(xintercept = mean(base$unauthorized, na.rm = TRUE), linetype = "dashed", color = "blue") + 
  ggtitle("GRÁFICA 1 - Histograma de unauthorized ") +
  theme_bw() +
  theme(plot.title = element_text(size = 18))

## Imputación de missing values con la mediana para Prop
base <- base  %>%
  mutate(prop = ifelse(is.na(prop) == TRUE, 
                       median(base$prop, na.rm = TRUE) , prop),
         unauthorized = ifelse(is.na(unauthorized) == TRUE, 
                       median(base$unauthorized, na.rm = TRUE), 
                       unauthorized))

## Imputación variables dicotómica con moda 
moda_auditada <- base %>% 
  filter(!is.na(Auditada)) %>% 
  count(Auditada) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(Auditada)

moda_AlreadyAudited <- base %>% 
  filter(!is.na(AlreadyAudited)) %>% 
  count(AlreadyAudited) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(AlreadyAudited)

moda_CorruptPast <- base %>% 
  filter(!is.na(CorruptPast)) %>% 
  count(CorruptPast) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(CorruptPast)

moda_Corrupt <- base %>% 
  filter(!is.na(Corrupt)) %>% 
  count(Corrupt) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(Corrupt)

moda_HOMI <- base %>% 
  filter(!is.na(HOMI_CAP_MUN)) %>% 
  count(HOMI_CAP_MUN) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(HOMI_CAP_MUN)

moda_grado <- base %>% 
  filter(!is.na(GradoSecundaria)) %>% 
  count(GradoSecundaria) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(GradoSecundaria)

moda_grado <- base %>% 
  filter(!is.na(GradoSecundaria)) %>% 
  count(GradoSecundaria) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(GradoSecundaria)

base <- base %>%
  mutate(Auditada = ifelse(is.na(Auditada) == TRUE, 
                           moda_auditada, Auditada),
         AlreadyAudited = ifelse(is.na(AlreadyAudited) == TRUE,
                                 moda_AlreadyAudited, AlreadyAudited),
         CorruptPast = ifelse(is.na(CorruptPast) == TRUE, 
                              moda_CorruptPast, CorruptPast),
         Corrupt = ifelse(is.na(Corrupt) == TRUE, 
                          moda_Corrupt, Corrupt),
         HOMI_CAP_MUN = ifelse(is.na(HOMI_CAP_MUN)  == TRUE, 
                               moda_HOMI, HOMI_CAP_MUN),
         GradoSecundaria = ifelse(is.na(GradoSecundaria)  == TRUE, 
                               moda_grado, GradoSecundaria))

## Convertir a factor variables categoricas
var_factor <- c("clavedelaescuela", "turno", "GradoSecundaria", "year",
                "clave_mun", "Auditada", "AlreadyAudited", "CorruptPast",
                "Corrupt")

base <- base %>%
  mutate(across(all_of(var_factor), as.factor))
```

### 1. Especificación de la regresión

La especificación principal del autor consiste en regresar la proporción de estudiantes que hicieron trampa en el colegio *c*, en el grado *g*, del municipio *m* en el año *t* (prop) contra variables de control. De tal forma que, se puede realizar una aproximación matemática de la regresión que el Nicolás Ajzeman (2021) indica como:

$$Prop_{sgmt}=β_0+β_1 Corrupt_{mt}+β_2 Auditada_{mt}+X_{smgt}Γ+λ_s+ δ_t + ε_{is}$$ Donde la variable dependiente:

-   $Prop_{sgmt}$ caputura la proporción de estudiantes que hicieron trampa. Está a nivel colegio *(s)*, grado *(g)*, municipio *(m)* y año *(t)*. Es un variable numérico entre 0 y 1.

Donde los parámetros y variables de interés son:

-   $Corrupt_{mt}$ corresponde a la variable de interés dicotómica que indica uno si hubo corrupción. Su nivel de agregación es municipio *(m)* y año *(t)*.

-   $Auditada_{mt}$ corresponde a la variable dicotómica que indica si hubo reportes de auditoria. Su nivel de agregación es municipio *(m)* y año *(t)*.

-   $β_1$ y $β_2$ son los parámetros de interés que responden a la pregunda de investigación, los cuales miden el efecto de la corrupción y las auditorías, respectivamente, sobre la proporción de estudiantes que hacen trampa.

Variables de control:

-   $X_{smgt}Γ$ corresponde a un vector de controles y sus coeficientes correspondientes. Este vector contiene:

    -   $grade_{gt}$ es el grado (nota) de los estudiantes, a nivel grado *(grado)* y año *(t)*. **\# corregir**

    -   $PartidoDesf_{mt}$ es el partido político activo, a nivel municipio *(m)* y año *(t)*.

    -   $AlredyAudited_{mt}$ es binaria, que toma uno para las auditorías anteriores a la fecha, a nivel municipio *(m)* y año *(t)*.

    -   $CorruptPast_{mt}$ es binaria que toma uno para corrupción en el pasado, a nivel municipio *(m)* y año *(t)*.

    -   $HOMI _ CAP _ MUN_{mt}$ son homicidios per cápita, a nivel municipio *(m)* y año *(t)*.

Donde, los efectos fijos son:

-   $λ_s$ corresponde a efectos fijos a nivel de colegio *s*. Controla por todas las características no observadas que son constantes en el tiempo dentro de cada colegio *(clavedelaescuela)*

-   $δ_t$ corresponde a los efectos fijos del tiempo *(year)*. Controla por todas las características no observadas que son comunes a todos los colegios en un año determinado a nivel de año *(t)*.

Términos adicionales:

-   $β_0$ es la constante del modelo.
-   $ε_{is}$ corresponde al término del error que captura todas las variables no observadas que afectan a la proporción de estudiantes que hacen trampa.

### 2. Resultados de estimación de regresiones

a)  Una regresión simple de la variable dependiente contra la independiente principal

```{r}
lm1<- lm (prop ~ Corrupt, base)
summary(lm1)
```

b)  Una regresión simple de la variable dependiente contra la independiente principal + controles

```{r}
# Regresión por MCO con controles
lm2 <- lm (prop ~ Corrupt + Auditada + GradoSecundaria + PartidoDesf + AlreadyAudited + CorruptPast + HOMI_CAP_MUN + total + MismoPartidoG , base)
summary(lm2)
```

c)  Una regresión simple de la variable dependiente contra la independiente principal + efectos fijos

```{r}
# Matriz con efectos fijos 
m_base <- pdata.frame(base, index = c("clavedelaescuela", "year"))

# Modelo de efectos fijos (within estimator)
m_ef1 <- plm(prop ~ Corrupt, 
                   data = m_base, 
                   model = "within", effect = "twoways") # Estimación de modelo de EF y se especifica que se controle por ambas dimensiones, escuela y años.

summary(m_ef1)
```



d)  Una regresión simple de la variable depediente contra la independiente principal + controles + efectos fijos

```{r}

m_ef2 <- plm(prop ~ Corrupt + Auditada + GradoSecundaria + PartidoDesf + AlreadyAudited + CorruptPast + HOMI_CAP_MUN, 
                   data = m_base, 
                   model = "within", effect = "twoways")

summary(m_ef2)
```


Modelo extra sin PartidoDesf

```{r}

m_extra <- plm(prop ~ Corrupt + Auditada + GradoSecundaria + AlreadyAudited + CorruptPast + HOMI_CAP_MUN, 
                   data = m_base, 
                   model = "within", effect = "twoways")

summary(m_extra)
```

Tabla de resultados de las estimaciones de los puntos a, b, c, d.

```{r}

library(stargazer)

stargazer(lm1, lm2, m_ef1, m_ef2,
          type = "text",              # Cambiar a "html" o "latex" si quieres
          keep = "Corrupt",           # Solo muestra el coeficiente de interés
          column.labels = c("MCO", "MCO con Controles", "E.F.", "E.F con Controles"),
          dep.var.labels = "Proporción",
          covariate.labels = "Corrupción",
          digits = 3,
          no.space = TRUE,
          title = "Resultados de las regresiones",
          add.lines = list(
            c("Controles", "No", "Sí", "No", "Sí"),
            c("Efectos fijos", "No", "No", "Sí", "Sí")
          ),
          notes = "Errores estándar entre paréntesis. Solo se reporta el coeficiente de 'Corrupt'.")

```

### 3. Interpretación de resultados

Interpretar los resultados encontrados a partir de la primera regresión (estimación punto 2, inciso b)

**¿Parece haber una relación entre la corrupción política y la trampa de los estudiantes?**

El coeficiente estimado para la variable Corrupción política es positivo pero no resulta estadísticamente significativo. Esto indica que, una vez controladas las demás variables (características de la escuela, auditorías, contexto municipal, etc.), no se encuentra evidencia robusta de una asociación entre corrupción política y la proporción de estudiantes que hacen trampa. Aunque el coeficiente tiene signo positivo, su magnitud es muy pequeña (aprox. 0.00046), adicionalmente, su p-valor es de 0.737284, el cual es superior a los umbrales de significancia de 0.05. Lo anterior sugiere que, aun de existir un efecto, este sería prácticamente irrelevante en términos estadísticos y sustantivos debido a que contradice las expectativas de que una cultura de deshonestidad a nivel político se refleje como trampa de los estudiantes.

------------------------------------------------------------------------

**¿Podemos interpretar esta relación como causal?**

Este resultado no puede interpretarse como evidencia causal. El hecho de que la corrupción no sea significativa en esta especificación puede deberse a problemas de medición, variables omitidas o correlaciones no observadas que distorsionan la estimación. Incluso si hubiera significancia, la estimación seguiría siendo solo una correlación.

Lo anterior se basa al considerar principalmente el problema de variables omitidas, ya que para una relación causal, seria importante considerar variables constantes en el tiempo dentro de la escuela como objeto de estudio, tales como: cultura estudiantil y lineamientos de comportamiento establecidos por las escuelas, entre otros; asimismo, controlar por factores comunes en todas las escuelas que hacen parte del estudio.

Adicionalmente, el modelo demuestra endogeneidad al materializarse la causalidad inversa debido a la variable Auditada1. Para este caso, el coeficiente de la variable es de 0.004618 y presenta significancia estadística, lo cual indica que las auditorías pueden ser enfocadas en instituciones con sospecha de trampa, y esa misma sospecha estar correlacionada con la trampa estudiantil.

------------------------------------------------------------------------

**¿Cuál sería el supuesto de identificación?**

El supuesto de identificación es que el valor esperado de la trampa que habrían tenido los colegios con corrupción si no hubieran tenido corrupción es igual al valor esperado de la trampa observada en los colegios sin corrupción. En otras palabras, se asume que, en ausencia de corrupción, los colegios corruptos se comportarían igual que los no corruptos. Bajo ese supuesto, las diferencias observadas en trampa pueden atribuirse únicamente a la corrupción. Sin embargo, este supuesto es bastante fuerte: es probable que los colegios corruptos y no corruptos difieran en otras características (recursos, nivel socioeconómico, ubicación, etc.), y esas diferencias también afectan la trampa. Por eso la identificación causal es débil en este caso.

------------------------------------------------------------------------

### 4. Mejor especificación

A continuación, se elige la regresión de Efectos Fijos con Controles (4) en la tabla resumen, la cual parece ser la más adecuada para aproximarse a la respuesta de la pregunta de investigación del autor **¿....? porque.....**

Adiconalmente, para dar respuesta a **¿Cuál es el supuesto de identificación para que esta especificación permita hacer interpretaciones causales?** es posible considerar que.....

### 5. Interpretación de coeficiente estimado

Teniendo en cuenta la especificación anterior (punto 4) se interpreta que el coeficiente estimado para la variable **Corrupt1** en el modelo de efectos fijos con controles (Modelo 4) es de **0.0030483**. Este valor es estadísticamente significativo a un nivel de confianza del 5%, con un p-valor de 0.0496432.

Esto significa que, manteniendo constantes los efectos fijos de la escuela y del año, y controlando por las demás variables, el hecho de que un municipio pase a ser considerado "corrupto" está asociado con un aumento promedio de **0.003 puntos porcentuales** en la proporción de estudiantes que hacen trampa. Este es un efecto positivo, lo que indica que la corrupción municipal se relaciona con un mayor comportamiento de trampa en las escuelas, pero la magnitud del efecto es muy pequeña en términos prácticos. La significancia estadística sugiere que esta relación no es producto del azar y que las variables de omitidas estaban ocultando esta relación en los modelos más simples.
